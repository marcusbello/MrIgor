@{
    ViewData["Title"] = "Join Us";
}


<style>
    body {
        color: #212529;
    }
    .onboard-container {
        max-width: 600px;
        margin: 3rem auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 2rem 2.5rem;
    }
    .progress {
        height: 6px;
        border-radius: 4px;
    }
    .step-title {
        font-weight: 700;
        font-size: 1.4rem;
    }
    .btn-primary {
        background-color: #0d6efd;
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-weight: 600;
    }
    .plan-box {
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: border-color 0.2s ease;
    }
    .plan-box.active {
        border-color: #0d6efd;
        background-color: #f8f9ff;
    }
    .step {
        display: none;
    }
    .step.active {
        display: block;
    }
</style>

<div class="onboard-container">
    <div class="mb-4">
        <div class="progress">
            <div id="progressBar" class="progress-bar bg-primary" style="width: 33%;"></div>
        </div>
        <p class="text-center text-muted mt-2" id="stepIndicator">Step 1 of 3</p>
    </div>

    <!-- Step 1 -->
    <div id="step1" class="step active">
        <h4 class="step-title mb-3 text-center">Welcome! Let's set up your first school.</h4>
        <p class="text-center text-muted mb-4">Tell us a bit about your school to get started.</p>

        <form id="formStep1">
            <div class="mb-3">
                <label class="form-label">School Name</label>
                <input type="text" id="schoolName" class="form-control" placeholder="e.g. Northwood High" required>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">School Type</label>
                    <input type="text" id="schoolType" class="form-control" placeholder="e.g. High School" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">City / Country</label>
                    <input type="text" id="schoolCity" class="form-control" placeholder="e.g. London, UK" required>
                </div>
            </div>
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary w-100">Create School & Continue →</button>
            </div>
        </form>
    </div>

    <!-- Step 2 -->
    <div id="step2" class="step">
        <h4 class="step-title mb-3 text-center">Your School is Ready!</h4>
        <p class="text-center text-muted mb-4">Choose a plan that fits your needs. You can always upgrade later.</p>

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="plan-box active" id="freePlan">
                    <h5 class="fw-bold">Free Plan</h5>
                    <p class="mb-1">$0 / month</p>
                    <ul class="mb-0 small">
                        <li>Student Information System</li>
                        <li>Limited Reporting</li>
                        <li>Attendance tracking</li>
                        <li>Basic Class Management</li>
                        <li>Limited to 2 Teachers</li>
                        <li>Up to 10 Subjects</li>
                        <li>Limited to 50 Students</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="plan-box" id="premiumPlan">
                    <h5 class="fw-bold d-flex justify-content-between">
                        Premium Plan <span class="badge bg-warning text-dark">Popular</span>
                    </h5>
                    <p class="mb-1">$39 / month</p>
                    <ul class="mb-0 small">
                        <li>Everything in Free, plus:</li>
                        <li>Communication Portal</li>
                        <li>Timetable + Class scheduling</li>
                        <li>Exams, grades & transcripts</li>
                        <li>Unlimited students & Teachers</li>
                        <li>Advanced Analytics</li>
                        <li>Priority support</li>
                    </ul>
                </div>

                <!-- Hidden billing options -->
                <div id="billingOptions" class="mt-3" style="display:none;">
                    <label class="form-label fw-semibold">Choose Billing</label>
                    <select id="billingSelect" class="form-select">
                        <option value="" disabled>Select billing option</option>
                        <option value="monthly" selected>$39 / month (Monthly)</option>
                        <option value="yearly">$29 / month (Billed yearly)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button id="continueStep2" class="btn btn-primary w-100">Continue →</button>
        </div>
    </div>

    <!-- Step 3 -->
    <div id="step3" class="step">
        <h4 class="step-title mb-3 text-center">Invite a colleague to collaborate</h4>
        <p class="text-center text-muted mb-4">Would you like to add your first teacher now? You can always do this later from the dashboard.</p>

        <form id="formStep3">
            <div class="mb-3">
                <label class="form-label">Teacher's Full Name</label>
                <input type="text" id="teacherName" class="form-control" placeholder="e.g. Jane Doe">
            </div>
            <div class="mb-3">
                <label class="form-label">Teacher's Email Address</label>
                <input type="email" id="teacherEmail" class="form-control" placeholder="e.g. jane.doe@school.com">
            </div>
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary w-100">Send Invite & Finish →</button>
            </div>
        </form>

        <!-- Hidden form used to POST onboarding data to the server -->
        <form id="onboardingSubmitForm" asp-controller="Onboarding" asp-action="Submit" method="post" style="display:none;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="SelectedPlan" />
            <input type="hidden" name="BillingOption" />
            <input type="hidden" name="SchoolName" />
            <input type="hidden" name="SchoolType" />
            <input type="hidden" name="Address" />
            <input type="hidden" name="TeacherName" />
            <input type="hidden" name="TeacherEmail" />
        </form>
    </div>
</div>

@section Scripts {

    <script>
        const steps = ["step1", "step2", "step3"];
        let currentStep = 0;
        const progressBar = document.getElementById("progressBar");
        const stepIndicator = document.getElementById("stepIndicator");
        const planFromQuery = new URLSearchParams(window.location.search).get("plan");
        const billingOptions = document.getElementById("billingOptions");
        const billingSelect = document.getElementById("billingSelect");

        function showStep(i) {
            steps.forEach((s, idx) => document.getElementById(s).classList.toggle("active", i === idx));
            progressBar.style.width = `${((i + 1) / steps.length) * 100}%`;
            stepIndicator.textContent = `Step ${i + 1} of ${steps.length}`;
        }

        // Step 1
        document.getElementById("formStep1").addEventListener("submit", e => {
            e.preventDefault();
            localStorage.setItem("schoolName", document.getElementById("schoolName").value);
            localStorage.setItem("schoolType", document.getElementById("schoolType").value);
            localStorage.setItem("schoolCity", document.getElementById("schoolCity").value);
            currentStep = 1;
            showStep(currentStep);
        });

        // Plan selection
        const freePlan = document.getElementById("freePlan");
        const premiumPlan = document.getElementById("premiumPlan");

        freePlan.addEventListener("click", () => {
            freePlan.classList.add("active");
            premiumPlan.classList.remove("active");
            billingOptions.style.display = "none"; // hide billing menu
            billingSelect.value = ""; // reset
            localStorage.setItem("plan", "Free");
            localStorage.removeItem("billingOption");
        });

        premiumPlan.addEventListener("click", () => {
            premiumPlan.classList.add("active");
            freePlan.classList.remove("active");
            billingOptions.style.display = "block";
            localStorage.setItem("plan", "Premium");
        });

        // SAVE BILLING OPTION
        billingSelect.addEventListener("change", () => {
            localStorage.setItem("billingOption", billingSelect.value);
        });

        document.getElementById("continueStep2").addEventListener("click", () => {
            currentStep = 2;
            showStep(currentStep);
        });

        // Step 3 — submit onboarding to server
        document.getElementById("formStep3").addEventListener("submit", e => {
            e.preventDefault();

            // Save teacher locally
            const teacherName = document.getElementById("teacherName").value || "";
            const teacherEmail = document.getElementById("teacherEmail").value || "";
            localStorage.setItem("teacherName", teacherName);
            localStorage.setItem("teacherEmail", teacherEmail);

            // Gather school info (from step1 inputs)
            const schoolName = document.getElementById("schoolName") ? document.getElementById("schoolName").value : "";
            const schoolType = document.getElementById("schoolType") ? document.getElementById("schoolType").value : "";
            const address = document.getElementById("schoolCity") ? document.getElementById("schoolCity").value : "";

            // Determine selected plan and billing
            const selectedPlan = localStorage.getItem("plan") || (planFromQuery || "Free");
            const billing = (billingSelect && billingSelect.value) ? billingSelect.value : "monthly";

            // Populate hidden form and submit to controller
            const postForm = document.getElementById("onboardingSubmitForm");
            postForm.elements["SelectedPlan"].value = selectedPlan;
            postForm.elements["BillingOption"].value = billing;
            postForm.elements["SchoolName"].value = schoolName;
            postForm.elements["SchoolType"].value = schoolType;
            postForm.elements["Address"].value = address;
            postForm.elements["TeacherName"].value = teacherName;
            postForm.elements["TeacherEmail"].value = teacherEmail;

            postForm.submit();
        });

        showStep(currentStep);
    </script>

}
